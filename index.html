<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Golf Group Pace Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .tabs { margin-bottom: 20px; }
    .tabs button { margin-right: 10px; }
    .tab { display: none; }
    .active { display: block; }
    label { display: block; margin-top: 10px; }
    input[type="number"] { width: 50px; margin-right: 5px; }
    button.start-hole { margin-right: 5px; }
  </style>
</head>
<body>

  <h2>Golf Group Pace Tracker</h2>

  <div class="tabs">
    <button onclick="showTab('timeTab')">Time Tracker</button>
    <button onclick="showTab('paceTab')">Pace Tracker</button>
  </div>

  <div id="timeTab" class="tab">
    <label>Tee Time:</label>
    Hour: <input type="number" id="teeHour1" min="0" max="23">
    Minute: <input type="number" id="teeMin1" min="0" max="59">

    <label>Current Time:</label>
    Hour: <input type="number" id="currHour1" min="0" max="23">
    Minute: <input type="number" id="currMin1" min="0" max="59">

    <label>Starting Hole: <span id="selectedHole"></span></label>
    <button class="start-hole" onclick="setStartingHole(1)">Hole 1</button>
    <button class="start-hole" onclick="setStartingHole(10)">Hole 10</button>

    <br><br>
    <button onclick="calculateTime()">See Pace</button>
    <p id="result1"></p>
  </div>

  <div id="paceTab" class="tab">
    <label>Starting Hole: <span id="selectedHole2"></span></label>
    <label>Start Time:</label>
    Hour: <input type="number" id="teeHour2" min="0" max="23">
    Minute: <input type="number" id="teeMin2" min="0" max="59">

    <label>Holes Finished:</label>
    <input type="number" id="holesDone" min="0" max="18">

    <label>Starting Hole: <span id="selectedHole"></span></label>
    <button class="start-hole" onclick="setStartingHole2(1)">Hole 1</button>
    <button class="start-hole" onclick="setStartingHole2(10)">Hole 10</button>

    <br><br>
    <button onclick="calculatePace()">See Pace</button>
    <p id="result2"></p>
  </div>

  <script>
    const holeTimes = [14,12,13,15,14,13,12,16,14,13,15,14,13,12,14,15,13,14];
    function showTab(id) {
      document.querySelectorAll('.tab').forEach(div => div.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
    showTab('timeTab');

    let wasm;
    fetch('golf.wasm')
      .then(r => r.arrayBuffer())
      .then(bytes => WebAssembly.instantiate(bytes, {}))
      .then(obj => { wasm = obj.instance.exports; });

    let startHole1 = 1, startHole2 = 1;
    function setStartingHole(h) { startHole1 = h; document.getElementById("selectedHole").innerText = "Hole " + h; }
    function setStartingHole2(h) { startHole2 = h; document.getElementById("selectedHole2").innerText = "Hole " + h; }

    function reorder(times, start) {
      return start === 1 ? times : times.slice(9).concat(times.slice(0,9));
    }

    function loadTimes(arr) {
      const mem = new Float64Array(wasm.memory.buffer, 0, 20);
      for (let i=0; i<18; i++) mem[i] = arr[i];
    }

    function getProgress(elapsed, timesArr) {
      loadTimes(timesArr);
      const percentPtr = 18 * 8;
      const idx = wasm.getHoleIndex(elapsed, 0, 18, percentPtr/8);
      const pct = new Float64Array(wasm.memory.buffer, percentPtr, 1)[0];
      return { idx, pct };
    }

    function calculateTime() {
      const tee = (Number(teeHour1.value)||0)*60 + (Number(teeMin1.value)||0);
      const curr = (Number(currHour1.value)||0)*60 + (Number(currMin1.value)||0);
      const elapsed = curr - tee;
      if (elapsed < 0) {
        result1.innerText = 'Tee time must be before current time.';
        return;
      }
      const times = reorder(holeTimes, startHole1);
      const { idx, pct } = getProgress(elapsed, times);
      const holeNum = startHole1===1 ? idx+1 : (idx+10>18 ? idx-8 : idx+10);
      result1.innerText = `You are ${pct.toFixed(1)}% through Hole ${holeNum}.`;
    }

    function calculatePace() {
      const now = new Date();
      const curr = now.getHours()*60 + now.getMinutes();
      const tee = (Number(teeHour2.value)||0)*60 + (Number(teeMin2.value)||0);
      const elapsed = curr - tee;
      if (elapsed < 0) {
        result2.innerText = 'Start time must be before now.';
        return;
      }
      const done = Number(holesDone.value)||0;
      const times = reorder(holeTimes, startHole2);
      const expected = times.slice(0, done).reduce((a,b)=>a+b, 0);
      const diff = elapsed - expected;
      const behindAhead = diff>0 ? 'behind' : 'ahead';
      const { idx, pct } = getProgress(elapsed, times);
      const holeNum = startHole2===1 ? idx+1 : (idx+10>18 ? idx-8 : idx+10);
      result2.innerText = `You are ${Math.abs(diff).toFixed(1)} min ${behindAhead} pace.
You should be ${pct.toFixed(1)}% through Hole ${holeNum}.`;
    }
  </script>
</body>
</html>
